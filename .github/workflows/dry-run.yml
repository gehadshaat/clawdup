# CI workflow that builds Clawup and optionally exercises it in dry-run mode.
# Always validates that the project compiles and the CLI is loadable.
# If ClickUp secrets are configured, also runs a full dry-run.
#
# Optional repository secrets (enable full dry-run):
#   CLICKUP_API_TOKEN       - ClickUp API token (read-only access is sufficient)
#   CLICKUP_LIST_ID         - ClickUp list ID to poll (use a dedicated CI test list)
#   CLICKUP_PARENT_TASK_ID  - Alternative to CLICKUP_LIST_ID (poll subtasks instead)

name: Dry Run

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  dry-run:
    name: Clawup Dry Run
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: CLI smoke test
        run: node dist/cli.js --help

      - name: Check secrets availability
        id: secrets-check
        run: |
          if [ -n "$CLICKUP_API_TOKEN" ]; then
            echo "has_secrets=true" >> "$GITHUB_OUTPUT"
            echo "ClickUp secrets are configured — full dry-run will execute."
          else
            echo "has_secrets=false" >> "$GITHUB_OUTPUT"
            echo "ClickUp secrets not configured — skipping full dry-run (build + smoke test passed)."
          fi
        env:
          CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}

      - name: Run Clawup dry-run
        if: steps.secrets-check.outputs.has_secrets == 'true'
        env:
          CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
          CLICKUP_LIST_ID: ${{ secrets.CLICKUP_LIST_ID }}
          CLICKUP_PARENT_TASK_ID: ${{ secrets.CLICKUP_PARENT_TASK_ID }}
          DRY_RUN: "true"
          LOG_LEVEL: debug
        run: |
          node dist/cli.js --dry-run 2>&1 | tee dry-run.log
          echo "Exit code: $?"

      - name: Check for error markers in logs
        if: steps.secrets-check.outputs.has_secrets == 'true'
        run: |
          if grep -qi "Fatal error:" dry-run.log; then
            echo "::error::Dry run produced fatal errors"
            exit 1
          fi
          if grep -qi "ERROR: Missing required" dry-run.log; then
            echo "::error::Dry run has missing configuration"
            exit 1
          fi
          echo "No error markers found in logs."

      - name: Upload dry-run logs
        if: steps.secrets-check.outputs.has_secrets == 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: dry-run-logs
          path: dry-run.log
          retention-days: 14
